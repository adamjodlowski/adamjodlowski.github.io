<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Runtime Permissions</title>
<link rel="stylesheet" href="http://app.classeur.io/base-min.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="export-container"><h1 id="android-runtime-permissions">Android Runtime Permissions</h1>
<p>Permissions are used to restrict access to sensitive resources, data and hardware features. Android 6.0 Marshmallow (SDK level 23) introduced the concept of Runtime Permissions, changing many aspects of managing them in Android. The change is aimed to greatly improve user experience and it seems the Android Team did just that. On the other hand, developers need to incorporate those changes into their apps, which might not look that easy at first glance.</p>
<h2 id="traditional-permission-model">Traditional permission model</h2>
<ul>
<li>application install requires all of the permissions to be accepted by the user</li>
<li>the only way to revoke them is to uninstall application (all or nothing approach)</li>
<li>new permissions prevent apps from auto-updating, they need additional review by the user<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup></li>
<li>required permissions are declared in Android Manifest and application can  assume, that if it is installed, it has all of them granted</li>
</ul>
<h2 id="new-runtime-permission-model">New runtime permission model</h2>
<p>Now, every permission falls into one of three protection levels:</p>
<ul>
<li>normal – applications get them by default at the time of installation (for instance Internet connectivity)</li>
<li>dangerous – must be granted explicitly by the user</li>
<li>signature – custom permissions based on signing certificates that should match in order to request them, typically used by applications by the same developer in order to exchange some private, proprietary data</li>
</ul>
<p>In addition to protection levels, new concept of <a href="http://developer.android.com/guide/topics/security/permissions.html#perm-groups">permission groups</a> has been introduced:</p>
<ul>
<li>few separate permissions (like we are used to) might be grouped together into one group</li>
<li>user implicitly grants us all permissions from the group, that requested permission belongs to</li>
<li>if we ask for more than one permission in a group, they are granted/denied automatically based on user’s decision regarding the group</li>
</ul>
<blockquote>
<p>Don’t assume that if you possess a permission from particular group, you also have all the other permissions from that group – always ask for specific ones, because current behavior might change in the future.</p>
</blockquote>
<p>What all of that means for your users, is they can just install any given app from the Play Store and start using it right away (no questions during installation asked). Permissions falling into <em>normal protection level</em> are granted by default, and those should be enough for typical app to function, at least at the beginning. The process of asking for permissions is pushed back to the last possible moment – the moment that user wants to perform an action requiring <em>dangerous</em> permission, for example – action of taking a photo would be briefly interrupted by a system dialog with permission request. Finally, user can grant or revoke<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> any permission at any time from system settings, without uninstalling app.</p>
<p><img src="https://dl.dropboxusercontent.com/u/20220/adamjodlowski.github.io/screenshots/Screenshot%202015-12-10%2021.23.55.png" alt="App permissions can be fine-tuned separately app by app"></p>
<blockquote>
<p>When user <em>revokes permissions</em>, our application’s process gets killed.</p>
</blockquote>
<p>All is fine for the user, but life of an ordinary Android developer has just got slightly more complicated. We’re now required to take extra care and prepare for few scenarios, making sure that we:</p>
<ul>
<li>declare required permissions in Android Manifest as usual</li>
<li>check on-the-fly, that we are actually granted permissions required to perform given actions</li>
<li>disable certain UI controls or indicate in other ways that application could perform those actions, if it had those permissions</li>
<li>are prepared for permission revocation at any given time</li>
<li>make a clear distinction between permissions vital to your application and optional ones</li>
<li>show disclaimers and reasoning behind requests – up-front or in context as they are needed</li>
</ul>
<h2 id="asking-for-runtime-permissions">Asking for Runtime Permissions</h2>
<blockquote>
<p>All features are backported to both Support Library v4 and v13.</p>
</blockquote>
<h3 id="opt-in-for-runtime-permissions">1. Opt-in for Runtime Permissions</h3>
<p>In order to opt-in for Runtime Permissions, you need to build your application with Target SDK 23 or higher. If you’re using Gradle (which you should be doing), make sure it’s set in <code>build.gradle</code>:</p>
<pre class=" language-json"><code class="prism  language-json">compileSdkVersion <span class="token number">23</span>
targetSdkVersion <span class="token number">23</span>
</code></pre>
<h3 id="declare-permissions-in-androidmanifest">2. Declare permissions in AndroidManifest</h3>
<p>No changes here, declare needed permissions in <code>AndroidManifest.xml</code> as usual:</p>
<pre class=" language-xml"><code class="prism  language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
          <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.github.adamjodlowski.playground<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.ACCESS_FINE_LOCATION<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="make-sure-to-check-if-permissions-have-been-granted-and-ask-for-them-if-necessary">3. Make sure to check if permissions have been granted and ask for them if necessary</h3>
<p><img src="https://dl.dropboxusercontent.com/u/20220/adamjodlowski.github.io/screenshots/Screenshot%202015-12-10%2017.53.06.png" alt="System window pops up to get user's approval"></p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>

    @Override
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate<span class="token punctuation">(</span></span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate<span class="token punctuation">(</span></span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView<span class="token punctuation">(</span></span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission<span class="token punctuation">(</span></span><span class="token keyword">this</span><span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>ACCESS_FINE_LOCATION<span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions<span class="token punctuation">(</span></span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>ACCESS_FINE_LOCATION <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d<span class="token punctuation">(</span></span><span class="token string">"PLAYGROUND"</span><span class="token punctuation">,</span> <span class="token string">"Permission was already granted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRequestPermissionsResult<span class="token punctuation">(</span></span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> permissions<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> grantResults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">==</span> <span class="token number">123</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>grantResults<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> grantResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d<span class="token punctuation">(</span></span><span class="token string">"PLAYGROUND"</span><span class="token punctuation">,</span> <span class="token string">"Permission has been just granted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d<span class="token punctuation">(</span></span><span class="token string">"PLAYGROUND"</span><span class="token punctuation">,</span> <span class="token string">"Permission has been denied or request cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As you can see, we use few new methods from Runtime Permissions API. Those are fairly straightforward, but there are few things to note:</p>
<ul>
<li>you can request many permissions, passing an array to <code>ActivityCompat#requestPermissions()</code> method</li>
<li>you need to make sure the code is prepared for brief interruption introduced by the request, as well as correctly receive result in <code>onRequestPermissionsResult()</code>, the mechanism is the same as <code>onActivityResult()</code> that you should be already familiar with</li>
<li>you can check approval/denial on single permission level – notice that response contains requested permissions and separate results for them</li>
</ul>
<blockquote>
<p>You are required to check permissions status every time you might need them, don’t assume that you got permission once and it’s available forever.</p>
</blockquote>
<h2 id="additional-considerations">Additional considerations</h2>
<p>I suppose you’ve noticed that after first denial user is given the option not to bug them anymore with our request. This is virtually our last chance to explain them reasoning behind the request. In order to do that gracefully, API contains method that returns <code>true</code>, if we previously requested particular permission, but user denied the request:</p>
<pre class=" language-java"><code class="prism  language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale<span class="token punctuation">(</span></span><span class="token keyword">this</span><span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>ACCESS_FINE_LOCATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">// the request has been denied previously, show explanation why you need this, then request permission again!</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">// ask without explanations</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>Please note, this method returns <code>false</code> if user already checked <em>Never ask again</em> checkbox.</p>
</blockquote>
<p><img src="https://dl.dropboxusercontent.com/u/20220/adamjodlowski.github.io/screenshots/Screenshot%202015-12-10%2017.55.29.png" alt="Asking second time, user can permanently dismiss this dialog for our app"></p>
<p>There’s another feature introduced in SDK 23. You can ask for permissions only if the platform supports runtime permissions, so you can optionally provide new features, but don’t request new permissions from users on older platforms upon auto-update of existing installed app. All we need is declaration in Android Manifest:</p>
<pre class=" language-xml"><code class="prism  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission-sdk-23</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.ACCESS_FINE_LOCATION<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre>
<p>This permission would behave as runtime permission and request for it would appear only on Android 6.0 and newer.  For users on older platforms, nothing changes.</p>
<h2 id="few-points-to-keep-in-mind">Few points to keep in mind</h2>
<ul>
<li>apps compiled with Target SDK &lt; 23 are treated as usual</li>
<li>many basic permissions are granted by default</li>
<li>you still need to declare them in the Manifest</li>
<li>you must check every time you need them (<code>Activity#onCreate</code> is sufficient)</li>
</ul>
<blockquote>
<p>Protip: Android Studio parses annotations and warns you if you try to make an API call but don’t request needed permissions.</p>
</blockquote>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>That leads to developers requesting more permissions that they really need, in order to prevent already installed applications from bugging user again when new app features arrive. This is bad practice. <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p>This doesn’t mean legacy apps are going to crash like crazy after you <em>revoke permissions</em>, throwing Exceptions all over the place. What really happens is, on Android 23+, API calls that had been restricted would return empty data sets or default values, as if there were no data available. <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
</ol>
</section></div></body>
</html>